name: Pull Request Message

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize]

jobs:
  echo_message:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Set up Git
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Make API request
        id: myRequest
        run: |
          curl -s -o response.json -w "%{http_code}" "${{ secrets.API_URL }}/profile/${{ github.event.pull_request.user.login }}"
          status_code=${response: -3}
          echo "::set-output name=status_code::$status_code"
        continue-on-error: true
      # Fail the job if the source is database
      - name: If 404 pass the job
        run: |
          echo "testing the comment ${{ steps.myRequest.outputs }}" > message.txt
          gh pr comment ${{ github.event.pull_request.number }} --body-file=message.txt
          if [ ${{ steps.myRequest.outputs.status_code }} -eq 404 ]; then
            echo "${{ github.event.pull_request.user.login }}'s Profile exists in the database. So closing the pr" > message.txt
            gh pr comment ${{ github.event.pull_request.number }} --body-file=message.txt
            gh pr merge --admin --merge
          elif [ "${{ steps.myRequest.outputs.response }}" == "test" ]; then
            echo "${{ github.event.pull_request.user.login }}'s . Bypassing the check. as it is known user" > message.txt
            gh pr comment ${{ github.event.pull_request.number }} --body-file=message.txt
            gh pr merge --admin --merge
          elif [ ${{ steps.myRequest.outputs.status_code }} -eq 200 ] || [ ${{ steps.myRequest.outputs.status_code }} -eq 304 ]; then
            echo "${{ github.event.pull_request.user.login }}'s Profile exists in the database. So closing the pr" > message.txt
            gh pr comment ${{ github.event.pull_request.number }} --body-file=message.txt
            #has close
          else
            echo "${{ github.event.pull_request.user.login }}'s Something went wrong!. please get it reviewed!" > message.txt
            gh pr comment ${{ github.event.pull_request.number }} --body-file=message.txt
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
